éžå¸¸å¥½çš„é—®é¢˜ ðŸ‘ï¼Œ**é—´éš™é”ï¼ˆGap Lockï¼‰** æ˜¯ MySQL InnoDB å­˜å‚¨å¼•æ“Žä¸­çš„ä¸€ä¸ªéžå¸¸å…³é”®çš„æ¦‚å¿µï¼Œå®ƒä¸Ž **MVCCã€äº‹åŠ¡éš”ç¦»çº§åˆ«ã€é”æœºåˆ¶** éƒ½å¯†åˆ‡ç›¸å…³ã€‚ä¸‹é¢æˆ‘ä»¬ç³»ç»Ÿåœ°è®²æ¸…æ¥šå®ƒã€‚

------

## ä¸€ã€é—´éš™é”ï¼ˆGap Lockï¼‰å®šä¹‰

**é—´éš™é”ï¼ˆGap Lockï¼‰**ï¼š
 æ˜¯ä¸€ç§ **é”å®šç´¢å¼•è®°å½•ä¹‹é—´çš„â€œé—´éš™â€ï¼ˆgapï¼‰** çš„é”ï¼Œ
 **ä¸é”å®šå…·ä½“çš„è®°å½•å€¼**ï¼Œ
 ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†é˜²æ­¢ **å¹»è¯»ï¼ˆPhantom Readï¼‰**ã€‚

> å®ƒåªå­˜åœ¨äºŽ **å¯é‡å¤è¯»ï¼ˆREPEATABLE READï¼‰** ä»¥åŠæ›´é«˜çº§åˆ«çš„éš”ç¦»çº§åˆ«ä¸­ã€‚

------

## äºŒã€é—´éš™é”çš„ä½œç”¨

ä½œç”¨ï¼š
 âœ… é˜²æ­¢å…¶ä»–äº‹åŠ¡åœ¨æŸä¸ªèŒƒå›´å†… **æ’å…¥æ–°è®°å½•**ï¼Œé€ æˆå½“å‰äº‹åŠ¡é‡å¤æŸ¥è¯¢æ—¶ç»“æžœé›†ä¸ä¸€è‡´ï¼ˆå¹»è¯»ï¼‰ã€‚

ä¸¾ä¾‹è¯´æ˜Ž ðŸ‘‡

å‡è®¾è¡¨ `user`ï¼š

| id   | name |
| ---- | ---- |
| 10   | A    |
| 20   | B    |
| 30   | C    |

äº‹åŠ¡Aæ‰§è¡Œï¼š

```sql
BEGIN;
SELECT * FROM user WHERE id BETWEEN 10 AND 20 FOR UPDATE;
```

InnoDB ä¼šåŠ é”ï¼š

- è®°å½•é”(Record Lock)ï¼šé”ä½ id=10ã€id=20
- é—´éš™é”(Gap Lock)ï¼šé”ä½åŒºé—´ (10, 20)

ç»“æžœæ˜¯ï¼š

- å…¶ä»–äº‹åŠ¡ä¸èƒ½æ’å…¥ id=15ï¼ˆå› ä¸º 15 è½åœ¨ (10,20) ä¹‹é—´ï¼‰
- ä½†å¯ä»¥æ’å…¥ id=25ï¼ˆä¸åœ¨é”å®šé—´éš™ä¸­ï¼‰

------

## ä¸‰ã€é—´éš™é” vs è®°å½•é” vs Next-Key Lock

| é”ç±»åž‹                   | é”å®šå¯¹è±¡                 | è¯´æ˜Ž                                    |
| ------------------------ | ------------------------ | --------------------------------------- |
| **è®°å½•é” (Record Lock)** | å½“å‰ç´¢å¼•è®°å½•             | é”ä½æŸæ¡å·²å­˜åœ¨çš„è®°å½•                    |
| **é—´éš™é” (Gap Lock)**    | ä¸¤æ¡è®°å½•ä¹‹é—´çš„ç©ºéš™       | é˜²æ­¢æ’å…¥æ–°çš„è®°å½•                        |
| **Next-Key Lock**        | â€œè®°å½•é” + é—´éš™é”â€ çš„ç»„åˆ | InnoDB é»˜è®¤è¡Œé”ï¼Œé”ä½ä¸€ä¸ªèŒƒå›´ï¼Œé˜²æ­¢å¹»è¯» |

> InnoDB å®žé™…ä¸Šé»˜è®¤ä½¿ç”¨çš„æ˜¯ **Next-Key Lock**ï¼Œå³â€œé—´éš™é” + å½“å‰è¡Œé”â€çš„ç»„åˆé”å®šæœºåˆ¶ã€‚

------

## å››ã€äº§ç”Ÿé—´éš™é”çš„åœºæ™¯

é—´éš™é”ä¸»è¦å‡ºçŽ°åœ¨ä»¥ä¸‹è¯­å¥ä¸­ï¼š

1ï¸âƒ£ å¸¦èŒƒå›´çš„æŸ¥è¯¢ + é”å®šè¯­å¥ï¼š

```sql
SELECT * FROM user WHERE id > 10 AND id < 20 FOR UPDATE;
```

2ï¸âƒ£ å”¯ä¸€ç´¢å¼•æ¡ä»¶æœªå‘½ä¸­ï¼š

```sql
SELECT * FROM user WHERE id = 15 FOR UPDATE;
-- è‹¥15ä¸å­˜åœ¨ï¼Œé”å®šçš„æ˜¯ (10,20) é—´éš™
```

3ï¸âƒ£ èŒƒå›´åˆ é™¤æˆ–æ›´æ–°ï¼š

```sql
DELETE FROM user WHERE id BETWEEN 10 AND 20;
```

------

## äº”ã€é—´éš™é”çš„è§£é™¤

é—´éš™é”åªåœ¨ä»¥ä¸‹éš”ç¦»çº§åˆ«ä¸­å‡ºçŽ°ï¼š

| éš”ç¦»çº§åˆ«         | æ˜¯å¦ä½¿ç”¨é—´éš™é” | è¯´æ˜Ž                                       |
| ---------------- | -------------- | ------------------------------------------ |
| READ UNCOMMITTED | âŒ ä¸ä½¿ç”¨       | è¿žè¯»æœªæäº¤éƒ½å…è®¸                           |
| READ COMMITTED   | âœ… éƒ¨åˆ†ä½¿ç”¨     | ä»…ä½¿ç”¨è®°å½•é”ï¼Œä¸é”é—´éš™ï¼ˆé˜²å¹»è¯»ä¾é è¡Œç‰ˆæœ¬ï¼‰ |
| REPEATABLE READ  | âœ… ä½¿ç”¨         | é˜²æ­¢å¹»è¯»ï¼ˆé»˜è®¤InnoDBçº§åˆ«ï¼‰                 |
| SERIALIZABLE     | âœ… ä½¿ç”¨         | æ•´è¡¨é”å®šï¼Œé˜²æ­¢å¹¶å‘æ’å…¥                     |

------

## å…­ã€æ€»ç»“å£è¯€ ðŸ§ 

| ç±»åž‹       | é”çš„å¯¹è±¡           | é˜²æ­¢é—®é¢˜     | ä¸¾ä¾‹    |
| ---------- | ------------------ | ------------ | ------- |
| è®°å½•é”     | æŸæ¡è®°å½•           | é˜²æ­¢è„å†™     | id=10   |
| é—´éš™é”     | ä¸¤æ¡è®°å½•ä¹‹é—´çš„é—´éš™ | é˜²æ­¢å¹»è¯»æ’å…¥ | (10,20) |
| Next-Keyé” | è®°å½• + é—´éš™        | å½»åº•é˜²å¹»è¯»   | [10,20) |

------

## ä¸ƒã€å®žæˆ˜å»ºè®®

1. âš  **é¿å…ä¸å¿…è¦çš„èŒƒå›´é”**ï¼šå¦‚æžœåªæ˜¯é”æŸä¸ªå”¯ä¸€ä¸»é”®ï¼Œå°½é‡ä½¿ç”¨ç­‰å€¼æ¡ä»¶ã€‚
2. âš¡ **è°¨æ…Žä½¿ç”¨èŒƒå›´æ¡ä»¶ + FOR UPDATE**ï¼šå¯èƒ½å¼•å‘å¤§èŒƒå›´é—´éš™é”ï¼Œé™ä½Žå¹¶å‘ã€‚
3. âœ… **å¿…è¦æ—¶é™ä½Žéš”ç¦»çº§åˆ«åˆ° READ COMMITTED**ï¼Œå‡å°‘é—´éš™é”å¸¦æ¥çš„é”ç«žäº‰ã€‚

------

æ˜¯å¦éœ€è¦æˆ‘å¸®ä½ ç”»ä¸€ä¸ªå›¾æ¥å±•ç¤º **é—´éš™é”ã€è®°å½•é”ã€Next-Keyé”** çš„å…³ç³»ï¼Ÿï¼ˆç›´è§‚æ˜¾ç¤ºé”èŒƒå›´å’Œé˜²æ­¢æ’å…¥çš„æ•ˆæžœï¼‰