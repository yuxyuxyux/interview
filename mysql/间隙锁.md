非常好的问题 👍，**间隙锁（Gap Lock）** 是 MySQL InnoDB 存储引擎中的一个非常关键的概念，它与 **MVCC、事务隔离级别、锁机制** 都密切相关。下面我们系统地讲清楚它。

------

## 一、间隙锁（Gap Lock）定义

**间隙锁（Gap Lock）**：
 是一种 **锁定索引记录之间的“间隙”（gap）** 的锁，
 **不锁定具体的记录值**，
 主要目的是为了防止 **幻读（Phantom Read）**。

> 它只存在于 **可重复读（REPEATABLE READ）** 以及更高级别的隔离级别中。

------

## 二、间隙锁的作用

作用：
 ✅ 防止其他事务在某个范围内 **插入新记录**，造成当前事务重复查询时结果集不一致（幻读）。

举例说明 👇

假设表 `user`：

| id   | name |
| ---- | ---- |
| 10   | A    |
| 20   | B    |
| 30   | C    |

事务A执行：

```sql
BEGIN;
SELECT * FROM user WHERE id BETWEEN 10 AND 20 FOR UPDATE;
```

InnoDB 会加锁：

- 记录锁(Record Lock)：锁住 id=10、id=20
- 间隙锁(Gap Lock)：锁住区间 (10, 20)

结果是：

- 其他事务不能插入 id=15（因为 15 落在 (10,20) 之间）
- 但可以插入 id=25（不在锁定间隙中）

------

## 三、间隙锁 vs 记录锁 vs Next-Key Lock

| 锁类型                   | 锁定对象                 | 说明                                    |
| ------------------------ | ------------------------ | --------------------------------------- |
| **记录锁 (Record Lock)** | 当前索引记录             | 锁住某条已存在的记录                    |
| **间隙锁 (Gap Lock)**    | 两条记录之间的空隙       | 防止插入新的记录                        |
| **Next-Key Lock**        | “记录锁 + 间隙锁” 的组合 | InnoDB 默认行锁，锁住一个范围，防止幻读 |

> InnoDB 实际上默认使用的是 **Next-Key Lock**，即“间隙锁 + 当前行锁”的组合锁定机制。

------

## 四、产生间隙锁的场景

间隙锁主要出现在以下语句中：

1️⃣ 带范围的查询 + 锁定语句：

```sql
SELECT * FROM user WHERE id > 10 AND id < 20 FOR UPDATE;
```

2️⃣ 唯一索引条件未命中：

```sql
SELECT * FROM user WHERE id = 15 FOR UPDATE;
-- 若15不存在，锁定的是 (10,20) 间隙
```

3️⃣ 范围删除或更新：

```sql
DELETE FROM user WHERE id BETWEEN 10 AND 20;
```

------

## 五、间隙锁的解除

间隙锁只在以下隔离级别中出现：

| 隔离级别         | 是否使用间隙锁 | 说明                                       |
| ---------------- | -------------- | ------------------------------------------ |
| READ UNCOMMITTED | ❌ 不使用       | 连读未提交都允许                           |
| READ COMMITTED   | ✅ 部分使用     | 仅使用记录锁，不锁间隙（防幻读依靠行版本） |
| REPEATABLE READ  | ✅ 使用         | 防止幻读（默认InnoDB级别）                 |
| SERIALIZABLE     | ✅ 使用         | 整表锁定，防止并发插入                     |

------

## 六、总结口诀 🧠

| 类型       | 锁的对象           | 防止问题     | 举例    |
| ---------- | ------------------ | ------------ | ------- |
| 记录锁     | 某条记录           | 防止脏写     | id=10   |
| 间隙锁     | 两条记录之间的间隙 | 防止幻读插入 | (10,20) |
| Next-Key锁 | 记录 + 间隙        | 彻底防幻读   | [10,20) |

------

## 七、实战建议

1. ⚠ **避免不必要的范围锁**：如果只是锁某个唯一主键，尽量使用等值条件。
2. ⚡ **谨慎使用范围条件 + FOR UPDATE**：可能引发大范围间隙锁，降低并发。
3. ✅ **必要时降低隔离级别到 READ COMMITTED**，减少间隙锁带来的锁竞争。

------

是否需要我帮你画一个图来展示 **间隙锁、记录锁、Next-Key锁** 的关系？（直观显示锁范围和防止插入的效果）