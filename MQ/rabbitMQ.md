éå¸¸å¥½ ğŸ‘ æˆ‘æ¥ç»™ä½ ä¸€ä»½ **RabbitMQ é¢è¯•é¢˜ + è¯¦ç»†è§£æå¤§å…¨ï¼ˆæœ€æ–°ç‰ˆï¼Œé€‚åˆå¼€å‘å’Œæµ‹è¯•å²—ä½ï¼‰**ï¼ŒåŒ…æ‹¬ï¼š

- æ ¸å¿ƒæ¦‚å¿µ
- å·¥ä½œåŸç†
- å®é™…é—®é¢˜æ’æŸ¥
- é«˜çº§ç‰¹æ€§
- é¢è¯•åŠ åˆ†é—®é¢˜ï¼ˆæ¶æ„å±‚é¢ï¼‰

------

## ğŸ§© ä¸€ã€RabbitMQ åŸºç¡€æ¦‚å¿µ

| æ¦‚å¿µ                     | è¯´æ˜                                        |
| ------------------------ | ------------------------------------------- |
| **Broker**               | æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å®ä½“ï¼ˆRabbitMQ Serverï¼‰         |
| **Producer**             | æ¶ˆæ¯ç”Ÿäº§è€…ï¼Œå‘é€æ¶ˆæ¯åˆ°äº¤æ¢æœº                |
| **Consumer**             | æ¶ˆæ¯æ¶ˆè´¹è€…ï¼Œä»é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯                |
| **Queue**                | å­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨ï¼ˆFIFOï¼‰                      |
| **Exchange**             | æ¥æ”¶ç”Ÿäº§è€…æ¶ˆæ¯å¹¶æ ¹æ®è·¯ç”±è§„åˆ™åˆ†å‘åˆ°é˜Ÿåˆ—      |
| **RoutingKey**           | è·¯ç”±é”®ï¼Œç”¨äºåŒ¹é…æ¶ˆæ¯åˆ°é˜Ÿåˆ—çš„è§„åˆ™            |
| **Binding**              | äº¤æ¢æœºä¸é˜Ÿåˆ—ä¹‹é—´çš„ç»‘å®šå…³ç³»                  |
| **Virtual Host (vhost)** | ç±»ä¼¼å‘½åç©ºé—´ï¼Œéš”ç¦»ä¸åŒä¸šåŠ¡                  |
| **Channel**              | åŸºäº TCP è¿æ¥çš„è½»é‡çº§è™šæ‹Ÿè¿æ¥ï¼Œå‡å°‘è¿æ¥å¼€é”€ |
| **Connection**           | TCP è¿æ¥ï¼Œå®¢æˆ·ç«¯ä¸ RabbitMQ ä¹‹é—´çš„ç‰©ç†è¿æ¥  |

------

## ğŸ§  äºŒã€äº¤æ¢æœºç±»å‹ï¼ˆExchange Typeï¼‰

| ç±»å‹        | è¡Œä¸º                                  | åœºæ™¯                   |
| ----------- | ------------------------------------- | ---------------------- |
| **Direct**  | æ ¹æ® `routingKey` ç²¾ç¡®åŒ¹é…åˆ°é˜Ÿåˆ—      | æ—¥å¿—ç­‰çº§è·¯ç”±ã€å®šå‘æ¶ˆæ¯ |
| **Fanout**  | å¹¿æ’­ç»™æ‰€æœ‰ç»‘å®šé˜Ÿåˆ—ï¼ˆå¿½ç•¥ routingKeyï¼‰ | å‘å¸ƒè®¢é˜…æ¨¡å‹           |
| **Topic**   | é€šé…ç¬¦åŒ¹é… (`*`ã€`#`)                 | åˆ†ç±»è·¯ç”±ï¼Œå¦‚æ—¥å¿—ç³»ç»Ÿ   |
| **Headers** | æ ¹æ®æ¶ˆæ¯å¤´å±æ€§åŒ¹é…                    | ä¸å¸¸ç”¨ï¼Œçµæ´»ä½†æ€§èƒ½å·®   |

**ä¾‹ï¼š**

```java
channel.exchangeDeclare("topic_logs", "topic");
channel.queueBind("queue1", "topic_logs", "user.*");
```

------

## âš™ï¸ ä¸‰ã€å·¥ä½œæµç¨‹ç®€å›¾

```
Producer â†’ Exchange â†’ Binding (RoutingKey) â†’ Queue â†’ Consumer
```

1. ç”Ÿäº§è€…å‘é€æ¶ˆæ¯åˆ° Exchange
2. Exchange æ ¹æ®ç±»å‹ + RoutingKey å†³å®šæ¶ˆæ¯å»å“ªä¸ª Queue
3. Queue å°†æ¶ˆæ¯ä¼ é€’ç»™æ¶ˆè´¹è€…ï¼ˆæˆ–ç­‰å¾…æ¶ˆè´¹ï¼‰

------

## ğŸ§¾ å››ã€æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ï¼ˆACKï¼‰

| æ¨¡å¼                                  | å«ä¹‰                            |
| ------------------------------------- | ------------------------------- |
| **è‡ªåŠ¨ç¡®è®¤ï¼ˆautoAck = trueï¼‰**        | æ¶ˆè´¹å®Œç«‹å³åˆ é™¤ï¼Œä¸ç®¡æˆåŠŸä¸å¦    |
| **æ‰‹åŠ¨ç¡®è®¤ï¼ˆautoAck = falseï¼‰**       | æ¶ˆè´¹è€…å¤„ç†å®Œåè°ƒç”¨ `basicAck()` |
| **æ‹’ç»æ¶ˆæ¯ï¼ˆbasicNack/basicRejectï¼‰** | å¯é€‰æ‹©æ˜¯å¦é‡æ–°å…¥é˜Ÿï¼ˆrequeueï¼‰   |

**æ‰‹åŠ¨ç¡®è®¤æ¨èï¼š**

```java
channel.basicConsume("queueName", false, (consumerTag, message) -> {
    try {
        processMessage(message);
        channel.basicAck(message.getEnvelope().getDeliveryTag(), false);
    } catch (Exception e) {
        channel.basicNack(message.getEnvelope().getDeliveryTag(), false, true);
    }
}, consumerTag -> {});
```

------

## ğŸ§± äº”ã€æŒä¹…åŒ–æœºåˆ¶ï¼ˆç¡®ä¿æ¶ˆæ¯ä¸ä¸¢ï¼‰

| å¯¹è±¡             | è¯´æ˜                  | è®¾ç½®æ–¹æ³•                                       |
| ---------------- | --------------------- | ---------------------------------------------- |
| **é˜Ÿåˆ—æŒä¹…åŒ–**   | RabbitMQ é‡å¯ä¸ä¸¢é˜Ÿåˆ— | `channel.queueDeclare(..., durable=true, ...)` |
| **äº¤æ¢æœºæŒä¹…åŒ–** | åŒç†                  | `channel.exchangeDeclare(..., durable=true)`   |
| **æ¶ˆæ¯æŒä¹…åŒ–**   | æ¶ˆæ¯å­˜ç£ç›˜            | `MessageProperties.PERSISTENT_TEXT_PLAIN`      |

------

## ğŸ§® å…­ã€æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰

æ­»ä¿¡ï¼ˆDead Letterï¼‰åœºæ™¯ï¼š

- æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆ`basicReject`/`basicNack` ä¸” `requeue=false`ï¼‰
- æ¶ˆæ¯è¿‡æœŸï¼ˆTTL åˆ°æœŸï¼‰
- é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦è¢«ä¸¢å¼ƒ

**é…ç½®æ–¹å¼ï¼š**

```java
args.put("x-dead-letter-exchange", "dlx.exchange");
args.put("x-dead-letter-routing-key", "dlx.key");
channel.queueDeclare("normal.queue", true, false, false, args);
```

------

## â³ ä¸ƒã€å»¶è¿Ÿé˜Ÿåˆ—ï¼ˆDelay Queueï¼‰

RabbitMQ æ²¡æœ‰åŸç”Ÿå»¶è¿Ÿé˜Ÿåˆ—ï¼Œéœ€è¦ä½¿ç”¨ï¼š

- TTL + æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶
- æˆ–æ’ä»¶ `rabbitmq_delayed_message_exchange`

TTL å®ç°æ–¹å¼ï¼š

```java
args.put("x-message-ttl", 60000);  // 60s è¿‡æœŸ
```

------

## ğŸ§° å…«ã€RabbitMQ é›†ç¾¤ä¸é«˜å¯ç”¨

| æ¨¡å¼                         | ç‰¹ç‚¹                               |
| ---------------------------- | ---------------------------------- |
| **æ™®é€šé›†ç¾¤**                 | é˜Ÿåˆ—å…ƒæ•°æ®å…±äº«ï¼Œæ¶ˆæ¯å†…å®¹å­˜åœ¨å•èŠ‚ç‚¹ |
| **é•œåƒé˜Ÿåˆ—ï¼ˆHAï¼‰**           | é˜Ÿåˆ—å‰¯æœ¬å­˜åœ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œä¸»æŒ‚ä»é¡¶ä¸Š   |
| **ä»²è£é˜Ÿåˆ—ï¼ˆQuorum Queueï¼‰** | Raft åè®®å®ç°é«˜å¯ç”¨ï¼Œæ–°æ¨èæ–¹å¼    |

------

## ğŸ§© ä¹ã€å¸¸è§é¢è¯•é—®é¢˜ä¸ç­”æ¡ˆ

### 1ï¸âƒ£ RabbitMQ å¦‚ä½•ä¿è¯æ¶ˆæ¯å¯é æ€§ï¼Ÿ

> ä¸‰ä¸ªç»´åº¦ï¼š

1. ç”Ÿäº§ç«¯ï¼š`confirm + return` æœºåˆ¶
2. æœåŠ¡ç«¯ï¼šæ¶ˆæ¯æŒä¹…åŒ–ï¼ˆdurable + persistentï¼‰
3. æ¶ˆè´¹ç«¯ï¼šæ‰‹åŠ¨ ack ç¡®è®¤æœºåˆ¶

### 2ï¸âƒ£ confirm æ¨¡å¼å’Œäº‹åŠ¡æ¨¡å¼åŒºåˆ«ï¼Ÿ

| æ¨¡å¼             | è¯´æ˜                                   | æ€§èƒ½   |
| ---------------- | -------------------------------------- | ------ |
| **äº‹åŠ¡æ¨¡å¼**     | `txSelect() â†’ txCommit()/txRollback()` | æ…¢     |
| **confirm æ¨¡å¼** | å¼‚æ­¥å›è°ƒç¡®è®¤æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾ Exchange      | é«˜æ€§èƒ½ |

### 3ï¸âƒ£ RabbitMQ å¦‚ä½•å®ç°å»¶è¿Ÿæ¶ˆæ¯ï¼Ÿ

- ä½¿ç”¨ TTL + DLX
- æˆ–ä½¿ç”¨æ’ä»¶ `rabbitmq_delayed_message_exchange`

### 4ï¸âƒ£ RabbitMQ å¦‚ä½•é˜²æ­¢æ¶ˆæ¯å †ç§¯ï¼Ÿ

- å¢åŠ æ¶ˆè´¹è€…
- æ‰¹é‡ ACK
- ä½¿ç”¨é˜Ÿåˆ— TTL
- å®šæœŸæ¸…ç†æ­»ä¿¡

### 5ï¸âƒ£ å¦‚ä½•å®ç°æ¶ˆæ¯é¡ºåºæ€§ï¼Ÿ

- å•é˜Ÿåˆ— + å•æ¶ˆè´¹è€…
- æˆ–åœ¨åº”ç”¨å±‚åŠ ä¸šåŠ¡ ID é¡ºåºæ§åˆ¶

### 6ï¸âƒ£ å¦‚ä½•é˜²æ­¢æ¶ˆæ¯é‡å¤æ¶ˆè´¹ï¼Ÿ

- ä½¿ç”¨ **å¹‚ç­‰æ€§è®¾è®¡**ï¼ˆä¸šåŠ¡å±‚å»é‡ï¼Œå¦‚ Redis è®°å½• msgIdï¼‰
- ç”Ÿäº§ç«¯æ·»åŠ  **å”¯ä¸€æ¶ˆæ¯ ID**

### 7ï¸âƒ£ å¦‚ä½•åšæ¶ˆæ¯è¿½è¸ªï¼Ÿ

- ä½¿ç”¨ `message_id` æˆ– `correlation_id`
- å¯ç”¨æ’ä»¶ `rabbitmq_tracing`

------

## ğŸ”’ åã€RabbitMQ æ¶ˆæ¯ç¡®è®¤æµç¨‹æ€»ç»“å›¾

```
Producer â†’ Exchange â†’ Queue â†’ Consumer
      â†‘             â†“            â†“
   confirmCallback  ACK/NACK   é‡è¯• or DLX
```

------

## ğŸ’¬ åä¸€ã€RabbitMQ é¢è¯•åŠ åˆ†é—®é¢˜

| é—®é¢˜                         | è¯´æ˜                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| **RabbitMQ ä¸ Kafka åŒºåˆ«ï¼Ÿ** | RabbitMQï¼šä½å»¶è¿Ÿã€å¼ºä¸€è‡´æ€§ã€è½»é‡çº§Kafkaï¼šé«˜ååã€æ—¥å¿—æµå¤„ç†ã€å¤§æ•°æ® |
| **æ¶ˆæ¯é‡å¤æ¶ˆè´¹å¦‚ä½•è§£å†³ï¼Ÿ**   | æ¶ˆæ¯ ID å»é‡ã€å¹‚ç­‰æ€§                                         |
| **æ­»ä¿¡é˜Ÿåˆ—ä½¿ç”¨åœºæ™¯ï¼Ÿ**       | å¼‚å¸¸æ¶ˆæ¯å­˜æ”¾ã€å»¶è¿Ÿé˜Ÿåˆ—å®ç°                                   |
| **å¦‚ä½•ç›‘æ§ RabbitMQï¼Ÿ**      | ç®¡ç†ç•Œé¢ã€Prometheus + Grafanaã€`rabbitmqctl` å‘½ä»¤           |

------

## ğŸ§© åäºŒã€è¡¥å……ï¼šå¸¸ç”¨å‘½ä»¤

```bash
# æŸ¥çœ‹é˜Ÿåˆ—
rabbitmqctl list_queues

# æŸ¥çœ‹äº¤æ¢æœº
rabbitmqctl list_exchanges

# æŸ¥çœ‹è¿æ¥
rabbitmqctl list_connections

# æ¸…ç†é˜Ÿåˆ—
rabbitmqctl purge_queue queue_name
```

------

æ˜¯å¦å¸Œæœ›æˆ‘å¸®ä½ ç”Ÿæˆä¸€ä»½
 âœ… **ã€ŒRabbitMQ é¢è¯•é¢˜ + ç­”æ¡ˆ PDF æ–‡æ¡£ã€** æˆ–
 âœ… **ã€Œå¸¦å›¾çš„ RabbitMQ å·¥ä½œåŸç†é€ŸæŸ¥è¡¨ã€**ï¼Ÿ
 æˆ‘å¯ä»¥è‡ªåŠ¨æ’ç‰ˆå¹¶ç”Ÿæˆä¸€ä»½å¯æ‰“å°çš„ç‰ˆæœ¬ç»™ä½ ã€‚
 è¦æˆ‘ç”Ÿæˆå“ªä¸€ç§ï¼Ÿ

# è‡ªå·±çš„é—®é¢˜

# æ­»ä¿¡é˜Ÿåˆ—æ€ä¹ˆå¤„ç†ï¼Ÿ

éå¸¸å¥½ ğŸ‘ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯ **æ¶ˆæ¯é˜Ÿåˆ—ç³»ç»Ÿï¼ˆä¾‹å¦‚ RabbitMQã€Kafkaã€RocketMQï¼‰** çš„ç»å…¸é¢è¯•ä¸å®æˆ˜ç‚¹ã€‚  

<img src="C:\Users\yux86\Desktop\java\MQ\1.png" alt="50" style="zoom:30%;" />

æˆ‘ä»¬é‡ç‚¹è®²ï¼š  

> **Redis æ²¡æœ‰æ­»ä¿¡é˜Ÿåˆ—æœºåˆ¶**ï¼Œè€Œ RabbitMQ ç­‰æ¶ˆæ¯é˜Ÿåˆ—æœ‰ã€‚  
> ä½†ä½ çš„é—®é¢˜ã€Œæ­»ä¿¡é˜Ÿåˆ—æ€ä¹ˆå¤„ç†ã€ä¸€èˆ¬æŒ‡ **RabbitMQ æ­»ä¿¡é˜Ÿåˆ— (Dead Letter Queue, DLQ)** çš„ä½¿ç”¨ä¸å¤„ç†æµç¨‹ã€‚  

æˆ‘ä¸‹é¢å¸®ä½ åˆ†å››æ­¥è®²æ¸…æ¥šï¼š  
---

## ä¸€ã€ä»€ä¹ˆæ˜¯æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLQï¼‰

æ­»ä¿¡é˜Ÿåˆ—æ˜¯ç”¨æ¥å­˜æ”¾â€œ**æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹çš„æ¶ˆæ¯**â€çš„é˜Ÿåˆ—ã€‚

åœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ¶ˆæ¯ä»ç”Ÿäº§è€… â†’ æ™®é€šé˜Ÿåˆ— â†’ æ¶ˆè´¹è€…ã€‚  
ä½†å½“æ¶ˆæ¯å‡ºç°å¼‚å¸¸æ— æ³•è¢«å¤„ç†æ—¶ï¼Œä¼šè¢«è½¬å‘åˆ°â€œæ­»ä¿¡é˜Ÿåˆ—â€ï¼Œä»¥ä¾¿åç»­äººå·¥æ’æŸ¥æˆ–è¡¥å¿å¤„ç†ã€‚

---

## äºŒã€å“ªäº›æƒ…å†µä¼šäº§ç”Ÿâ€œæ­»ä¿¡æ¶ˆæ¯â€

æ­»ä¿¡æ¶ˆæ¯ä¸€èˆ¬ç”±ä»¥ä¸‹ 3 ç§æƒ…å†µè§¦å‘ï¼š

| æƒ…å†µ                                                         | è¯´æ˜                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| â‘  æ¶ˆæ¯è¢«æ‹’ç»ï¼ˆ`basic.reject` æˆ– `basic.nack`ï¼‰å¹¶ä¸” `requeue=false` | æ¶ˆè´¹è€…æ‹’ç»æ¶ˆè´¹ä¸”ä¸é‡æ–°å…¥é˜Ÿ                                   |
| â‘¡ æ¶ˆæ¯è¿‡æœŸï¼ˆTTL åˆ°æœŸï¼‰                                       | é˜Ÿåˆ—æˆ–æ¶ˆæ¯è®¾ç½®äº†è¿‡æœŸæ—¶é—´ `x-message-ttl`                     |
| â‘¢ é˜Ÿåˆ—æ»¡äº†                                                   | é˜Ÿåˆ—è¾¾åˆ°æœ€å¤§é•¿åº¦ï¼ˆ`x-max-length`ï¼‰æˆ–æœ€å¤§å­—èŠ‚æ•°ï¼ˆ`x-max-length-bytes`ï¼‰ |

---

## ä¸‰ã€æ­»ä¿¡é˜Ÿåˆ—çš„é…ç½®ï¼ˆRabbitMQ å®æˆ˜ï¼‰

åœ¨ RabbitMQ ä¸­ï¼Œ**æ­»ä¿¡é˜Ÿåˆ—å¹¶ä¸æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„é˜Ÿåˆ—**ï¼Œ  
è€Œæ˜¯ä¸€ä¸ªæ™®é€šé˜Ÿåˆ—ï¼Œåªæ˜¯ä½œä¸ºå…¶ä»–é˜Ÿåˆ—çš„â€œæ­»ä¿¡äº¤æ¢æœºï¼ˆDLXï¼‰â€çš„ç»‘å®šç›®æ ‡ã€‚

---

### 1ï¸âƒ£ æ­¥éª¤ç¤ºæ„

```text
Producer --> [Normal Exchange] --> [Normal Queue] --> Consumer
                             |
                             | (æ­»ä¿¡æ¡ä»¶è§¦å‘)
                             v
                      [DLX Exchange] --> [DLQ Queue]
```

---

### 2ï¸âƒ£ å®é™…é…ç½®ä»£ç ï¼ˆJava ç¤ºä¾‹ / Spring Bootï¼‰

```java
@Configuration
public class RabbitConfig {

    // æ™®é€šäº¤æ¢æœº
    public static final String NORMAL_EXCHANGE = "normal.exchange";
    // æ™®é€šé˜Ÿåˆ—
    public static final String NORMAL_QUEUE = "normal.queue";
    // æ­»ä¿¡äº¤æ¢æœº
    public static final String DEAD_LETTER_EXCHANGE = "dead.exchange";
    // æ­»ä¿¡é˜Ÿåˆ—
    public static final String DEAD_LETTER_QUEUE = "dead.queue";

    /** åˆ›å»ºæ™®é€šäº¤æ¢æœº */
    @Bean
    public DirectExchange normalExchange() {
        return new DirectExchange(NORMAL_EXCHANGE);
    }

    /** åˆ›å»ºæ­»ä¿¡äº¤æ¢æœº */
    @Bean
    public DirectExchange deadExchange() {
        return new DirectExchange(DEAD_LETTER_EXCHANGE);
    }

    /** åˆ›å»ºæ­»ä¿¡é˜Ÿåˆ— */
    @Bean
    public Queue deadQueue() {
        return QueueBuilder.durable(DEAD_LETTER_QUEUE).build();
    }

    /** åˆ›å»ºæ™®é€šé˜Ÿåˆ—å¹¶ç»‘å®šæ­»ä¿¡äº¤æ¢æœº */
    @Bean
    public Queue normalQueue() {
        Map<String, Object> args = new HashMap<>();
        args.put("x-dead-letter-exchange", DEAD_LETTER_EXCHANGE); // æŒ‡å®šæ­»ä¿¡äº¤æ¢æœº
        args.put("x-dead-letter-routing-key", "dead.key");        // æŒ‡å®šæ­»ä¿¡è·¯ç”±é”®
        args.put("x-message-ttl", 10000);                         // æ¶ˆæ¯è¿‡æœŸæ—¶é—´ 10 ç§’
        return QueueBuilder.durable(NORMAL_QUEUE).withArguments(args).build();
    }

    /** ç»‘å®šæ™®é€šäº¤æ¢æœºå’Œé˜Ÿåˆ— */
    @Bean
    public Binding normalBinding() {
        return BindingBuilder.bind(normalQueue()).to(normalExchange()).with("normal.key");
    }

    /** ç»‘å®šæ­»ä¿¡äº¤æ¢æœºå’Œæ­»ä¿¡é˜Ÿåˆ— */
    @Bean
    public Binding deadBinding() {
        return BindingBuilder.bind(deadQueue()).to(deadExchange()).with("dead.key");
    }
}
```

ğŸ”¹ å½“æ¶ˆæ¯åœ¨ `normal.queue` ä¸­è¿‡æœŸã€è¢«æ‹’ç»æˆ–è¶…é•¿æ—¶ï¼Œå°±ä¼šè¢«è½¬å‘åˆ° `dead.exchange`ï¼Œå†è¿›å…¥ `dead.queue`ã€‚

---

## å››ã€æ­»ä¿¡é˜Ÿåˆ—çš„å¤„ç†æ–¹å¼

### 1ï¸âƒ£ æ—¥å¿—ç›‘æ§ä¸äººå·¥æ’æŸ¥
æ­»ä¿¡é˜Ÿåˆ—é€šå¸¸ç”¨äºé—®é¢˜æ’æŸ¥ï¼Œç³»ç»Ÿå¯å®šæ—¶æ£€æµ‹æ­»ä¿¡é˜Ÿåˆ—é•¿åº¦ï¼š
```bash
rabbitmqctl list_queues name messages_ready messages_unacknowledged
```

### 2ï¸âƒ£ è‡ªåŠ¨è¡¥å¿æ¶ˆè´¹
åˆ›å»ºä¸€ä¸ªæ­»ä¿¡æ¶ˆè´¹è€…ï¼Œå¯¹æ­»ä¿¡é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œåˆ†ææ¶ˆæ¯æ¥æºä¸åŸå› ï¼š
```java
@RabbitListener(queues = DEAD_LETTER_QUEUE)
public void handleDeadLetter(String msg) {
    log.error("æ”¶åˆ°æ­»ä¿¡æ¶ˆæ¯: {}", msg);
    // æ ¹æ®åŸå› åˆ¤æ–­æ˜¯å¦é‡è¯•ã€ä¸¢å¼ƒæˆ–å‘Šè­¦
}
```

å¯ä»¥é€šè¿‡æ¶ˆæ¯å¤´å­—æ®µï¼ˆ`x-death`ï¼‰è·å–æ¶ˆæ¯çš„æ­»äº¡åŸå› ï¼š
```java
Map<String, Object> headers = message.getMessageProperties().getHeaders();
System.out.println(headers.get("x-death"));
```

---

### 3ï¸âƒ£ è¡¥å¿æœºåˆ¶ï¼ˆé‡è¯•/é‡æ–°å…¥é˜Ÿï¼‰
å¸¸è§ç­–ç•¥ï¼š
| ç­–ç•¥     | è¯´æ˜                                               |
| -------- | -------------------------------------------------- |
| è‡ªåŠ¨é‡è¯• | å°†æ­»ä¿¡é‡æ–°å‘å›åŸé˜Ÿåˆ—                               |
| äººå·¥è¡¥å¿ | åå°é¡µé¢/å®šæ—¶ä»»åŠ¡è¯»å–æ­»ä¿¡å¹¶é‡å‘                    |
| æŠ¥è­¦é€šçŸ¥ | å½“æ­»ä¿¡ç§¯å‹è¾¾åˆ°é˜ˆå€¼æ—¶å‘é€å‘Šè­¦ï¼ˆé’‰é’‰ã€å¾®ä¿¡æœºå™¨äººç­‰ï¼‰ |

ç¤ºä¾‹é‡æŠ•ï¼š
```java
rabbitTemplate.convertAndSend(NORMAL_EXCHANGE, "normal.key", msg);
```

---

### 4ï¸âƒ£ ç›‘æ§ä¸é˜²èŒƒ
- **è®¾ç½®åˆç†çš„ TTL**ï¼Œé¿å…æ¶ˆæ¯ç§¯å‹ï¼›
- **æ¶ˆè´¹è€…å¿…é¡» catch å¼‚å¸¸**ï¼Œé¿å…æ— æ„æ‹’ç»ï¼›
- **ç›‘æ§æ­»ä¿¡é˜Ÿåˆ—é•¿åº¦**ï¼›
- **æŒä¹…åŒ–æ­»ä¿¡æ—¥å¿—**ï¼Œæ–¹ä¾¿æ’æŸ¥ã€‚

---

## äº”ã€Redis ä¸æ­»ä¿¡çš„åŒºåˆ«

| å¯¹æ¯”é¡¹   | RabbitMQ         | Redis Stream                  |
| -------- | ---------------- | ----------------------------- |
| æ­»ä¿¡æœºåˆ¶ | âœ… å†…ç½®ï¼ˆDLXï¼‰    | âŒ æ— å†…ç½®æœºåˆ¶                  |
| å¤„ç†æ–¹å¼ | è½¬å‘è‡³æ­»ä¿¡äº¤æ¢æœº | éœ€æ‰‹åŠ¨å®ç°ï¼ˆå¦‚ç”¨å¤‡ç”¨ streamï¼‰ |
| æ¶ˆæ¯é‡è¯• | è‡ªåŠ¨/äººå·¥        | éœ€è‡ªå·±å†™é€»è¾‘ï¼ˆå¦‚é‡æ”¾ï¼‰        |
| åº”ç”¨åœºæ™¯ | MQ å¼‚å¸¸æ¶ˆæ¯å¤„ç†  | ç®€å•é˜Ÿåˆ—ã€å»¶è¿Ÿé˜Ÿåˆ—            |

å¦‚æœä½ åœ¨ Redis é‡Œè¦â€œæ¨¡æ‹Ÿæ­»ä¿¡â€ï¼Œå¯ä»¥é€šè¿‡ï¼š
- Stream + æ¶ˆè´¹è€…ç»„æœºåˆ¶ï¼›
- å½“æ¶ˆæ¯ `XACK` å¤±è´¥æ¬¡æ•°è¶…è¿‡é˜ˆå€¼å â†’ æ‰‹åŠ¨è½¬ç§»åˆ° `dead_stream`ï¼›
å®ç°ç®€æ˜“ DLQ æ•ˆæœã€‚

---

âœ… **æ€»ç»“ä¸€å¥è¯ï¼š**
> æ­»ä¿¡é˜Ÿåˆ—æ˜¯æ¶ˆæ¯æ— æ³•è¢«æ­£å¸¸æ¶ˆè´¹åçš„â€œä¿é™©ç®±â€ï¼Œ  
> æ ¸å¿ƒæ˜¯é€šè¿‡ DLX + TTL + æ‹’ç»æœºåˆ¶å®ç°ï¼Œ  
> åç»­äººå·¥æˆ–ç¨‹åºå†ä»æ­»ä¿¡é˜Ÿåˆ—ä¸­è¿›è¡Œè¡¥å¿æˆ–æ’æŸ¥ã€‚

---

æ˜¯å¦å¸Œæœ›æˆ‘ç»™ä½ ç”»ä¸€å¼  **â€œæ­»ä¿¡æ¶ˆæ¯æµè½¬ç¤ºæ„å›¾â€**ï¼ˆä»ç”Ÿäº§åˆ°è¿›å…¥ DLQ çš„å®Œæ•´æµç¨‹ï¼‰ï¼Ÿ  
å›¾ä¼šæŠŠäº¤æ¢æœºã€è·¯ç”±é”®ã€é˜Ÿåˆ—å’Œæ¶ˆæ¯æµèµ°å‘éƒ½æ ‡å‡ºæ¥ã€‚

# æ¶ˆæ¯æŒä¹…åŒ–ä¸ºä»€ä¹ˆä¼šä¿è¯ä¸ä¸¢ï¼Ÿ

è¿™ä¸ªé—®é¢˜é—®å¾—éå¸¸å…³é”® ğŸ‘â€”â€”â€œ**æ¶ˆæ¯æŒä¹…åŒ–ä¸ºä»€ä¹ˆä¸ä¼šä¸¢**â€ï¼Œå…¶å®è¦åˆ†ä¸¤å±‚æ¥ç†è§£ï¼š

> ğŸ’¬ **ä¸€æ˜¯ç†è®ºæœºåˆ¶ï¼ˆä¸ºä»€ä¹ˆâ€œåº”è¯¥â€ä¸ä¼šä¸¢ï¼‰ï¼Œ**
>  ğŸ’¬ **äºŒæ˜¯å®é™…å·¥ç¨‹å®ç°ï¼ˆåœ¨å“ªäº›æƒ…å†µä¸‹â€œçœŸçš„â€ä¸ä¼šä¸¢ï¼‰ã€‚**

æˆ‘æ¥å¸®ä½ ç³»ç»Ÿæ¢³ç†ä¸€ä¸‹ï¼ˆä½ å¯ä»¥å‘Šè¯‰æˆ‘å…·ä½“æŒ‡çš„æ˜¯å“ªç§æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œæ¯”å¦‚ Kafkaã€RabbitMQã€RocketMQã€Redis Streamï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»“åˆé‚£ä¸ªè¯´æ˜ï¼‰ã€‚

------

## ä¸€ã€æ¶ˆæ¯æŒä¹…åŒ–çš„æœ¬è´¨

æ‰€è°“ **æ¶ˆæ¯æŒä¹…åŒ–ï¼ˆMessage Persistenceï¼‰**ï¼Œå°±æ˜¯æŠŠæ¶ˆæ¯å†™å…¥ç£ç›˜ï¼ˆæˆ–å¯æ¢å¤å­˜å‚¨ï¼‰ï¼Œè€Œä¸æ˜¯åªæ”¾åœ¨å†…å­˜ä¸­ã€‚

ğŸ§  **æ ¸å¿ƒç›®çš„ï¼š**
 å½“ç³»ç»Ÿå´©æºƒã€è¿›ç¨‹é‡å¯ã€æ–­ç”µæˆ–å®•æœºåï¼Œæ¶ˆæ¯ä»ç„¶å¯ä»¥ä»ç£ç›˜ä¸­æ¢å¤ï¼Œä¸ä¼šä¸¢å¤±ã€‚

------

## äºŒã€ä¸ºä»€ä¹ˆæŒä¹…åŒ–åâ€œç†è®ºä¸Šä¸ä¼šä¸¢â€

æˆ‘ä»¬ä»¥é€šç”¨æœºåˆ¶è¯´æ˜ï¼ˆæ‰€æœ‰ä¸»æµ MQ éƒ½æ˜¯ç±»ä¼¼åŸç†ï¼‰ï¼š

### 1ï¸âƒ£ ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ â†’ å†™å…¥ç£ç›˜æ—¥å¿—ï¼ˆæˆ–é˜Ÿåˆ—æ–‡ä»¶ï¼‰

- å½“æ¶ˆæ¯åˆ°è¾¾ Broker æ—¶ï¼ŒBroker ä¸ä¼šç«‹å³ç¡®è®¤æˆåŠŸï¼›
- å®ƒä¼š**å…ˆå†™å…¥ç£ç›˜æ–‡ä»¶**ï¼ˆé€šå¸¸æ˜¯é¡ºåºå†™ï¼‰ï¼›
- å†™æˆåŠŸï¼ˆ`fsync` æˆ– `flush`ï¼‰åæ‰è¿”å› ACKï¼›
- å› æ­¤ï¼Œå³ä½¿ Broker å®•æœºï¼Œé‡å¯åå¯ä»¥ä»æ–‡ä»¶ä¸­æ¢å¤ã€‚

âœ… **ç¤ºä¾‹ï¼š**

- Kafka å†™å…¥ commit logï¼ˆé¡ºåºå†™ï¼‰ï¼›
- RabbitMQ å†™å…¥ Mnesia / Disk-backed queueï¼›
- RocketMQ å†™å…¥ CommitLogï¼›
- Redis Stream å†™å…¥ AOFã€‚

------

### 2ï¸âƒ£ æ¶ˆæ¯æ¶ˆè´¹ä¹Ÿæœ‰ç¡®è®¤æœºåˆ¶ï¼ˆackï¼‰

- æ¶ˆè´¹è€…æ¶ˆè´¹æ¶ˆæ¯åï¼Œéœ€è¦æ˜¾å¼ç¡®è®¤ï¼ˆACKï¼‰ã€‚
- åªæœ‰åœ¨ ACK ä¹‹åï¼ŒBroker æ‰è®¤ä¸ºè¯¥æ¶ˆæ¯â€œå·²æˆåŠŸå¤„ç†â€ï¼Œå¹¶å¯åˆ é™¤æˆ–æ ‡è®°ä¸ºå·²æ¶ˆè´¹ã€‚

è¿™æ„å‘³ç€ï¼š

> å¦‚æœæ¶ˆè´¹è€…åœ¨å¤„ç†è¿‡ç¨‹ä¸­æŒ‚äº†ï¼ˆæ²¡å‘ ACKï¼‰ï¼ŒBroker ä¼šè®¤ä¸ºæ¶ˆè´¹æœªå®Œæˆï¼Œä¸‹æ¬¡å¯é‡æ–°æŠ•é€’ã€‚

âœ… **è¿™ä¹Ÿæ˜¯â€œæ¶ˆæ¯ä¸ä¸¢â€çš„ç¬¬äºŒå±‚ä¿éšœã€‚**

------

### 3ï¸âƒ£ æ—¥å¿—æ–‡ä»¶ + ç´¢å¼•æ–‡ä»¶

- æ‰€æœ‰æŒä¹…åŒ–çš„æ¶ˆæ¯éƒ½å¸¦æœ‰ offset æˆ– sequence IDï¼›
- ç³»ç»Ÿå¯åœ¨å´©æºƒåé€šè¿‡ç´¢å¼•æ–‡ä»¶æ¢å¤æ•°æ®ï¼›
- æ—¥å¿—é‡‡ç”¨**é¡ºåºå†™ + æ ¡éªŒæœºåˆ¶**ï¼Œé¿å…å†™å…¥ä¸­æ–­å¯¼è‡´æ•°æ®æŸåã€‚

------

### 4ï¸âƒ£ å†™å…¥ç¡®è®¤ç­–ç•¥

æœ‰äº›ç³»ç»Ÿæä¾›ä¸åŒçº§åˆ«çš„ç¡®è®¤æœºåˆ¶ï¼Œæ¯”å¦‚ï¼š

| ç³»ç»Ÿ             | ç­–ç•¥                  | è¯´æ˜                                   |
| ---------------- | --------------------- | -------------------------------------- |
| **Kafka**        | `acks=0/1/all`        | all è¡¨ç¤ºæ¶ˆæ¯å¿…é¡»åŒæ­¥åˆ°æ‰€æœ‰å‰¯æœ¬æ‰ç®—æˆåŠŸ |
| **RabbitMQ**     | `publisher confirms`  | æ¶ˆæ¯å†™å…¥ç£ç›˜å¹¶åŒæ­¥æˆåŠŸæ‰å› ACK         |
| **RocketMQ**     | åŒæ­¥åˆ·ç›˜/å¼‚æ­¥åˆ·ç›˜     | åŒæ­¥åˆ·ç›˜æœ€å®‰å…¨ä½†å»¶è¿Ÿé«˜                 |
| **Redis Stream** | AOF æŒä¹…åŒ– + ä¸»ä»å¤åˆ¶ | ä¸»ä»åŒæ­¥åæ‰ç®—å®‰å…¨                     |

é€‰å¯¹ç­–ç•¥åï¼Œå³ä½¿å•æœºå®•æœºï¼Œæ•°æ®ä¹Ÿèƒ½åœ¨å‰¯æœ¬æˆ–æ—¥å¿—ä¸­æ¢å¤ã€‚

------

## ä¸‰ã€ä½†æ˜¯ â€”â€” å®é™…ä¸Šä»ç„¶**å¯èƒ½ä¸¢**

æŒä¹…åŒ– â‰  ç»å¯¹ä¸ä¸¢ã€‚å¸¸è§çš„ä¸¢å¤±åœºæ™¯åŒ…æ‹¬ï¼š

| åœºæ™¯               | åŸå›                          | è§£å†³æ–¹æ¡ˆ                        |
| ------------------ | ---------------------------- | ------------------------------- |
| â‘  Broker å¼‚æ­¥åˆ·ç›˜  | æ¶ˆæ¯å†™å…¥ç¼“å­˜ä½†æœªè½ç›˜å³å®•æœº   | æ”¹ä¸ºåŒæ­¥åˆ·ç›˜ï¼ˆfsyncï¼‰           |
| â‘¡ æ²¡å¼€å¯ç”Ÿäº§è€…ç¡®è®¤ | ç”Ÿäº§è€…ä»¥ä¸ºå‘æˆåŠŸï¼Œå…¶å®æ²¡å†™å…¥ | æ‰“å¼€ç¡®è®¤æœºåˆ¶ï¼ˆacks / confirmsï¼‰ |
| â‘¢ æœªé…ç½®å‰¯æœ¬æœºåˆ¶   | å•èŠ‚ç‚¹æŸåæˆ–ç£ç›˜å           | å¯ç”¨å¤šå‰¯æœ¬åŒæ­¥                  |
| â‘£ æ¶ˆè´¹è€…è‡ªåŠ¨ ack   | æ¶ˆè´¹å¤±è´¥ä½†å·²æ ‡è®°æˆåŠŸ         | æ”¹ä¸ºæ‰‹åŠ¨ ackï¼Œå¤±è´¥å¯é‡è¯•        |
| â‘¤ ç£ç›˜æ•°æ®æŸå     | æ–‡ä»¶ç³»ç»Ÿå¼‚å¸¸                 | ä½¿ç”¨æ—¥å¿—æ ¡éªŒ + å¿«ç…§å¤‡ä»½         |

------

## âœ… å°ç»“ï¼šä¸ºä»€ä¹ˆæ¶ˆæ¯æŒä¹…åŒ–ä¸ä¼šä¸¢

> å› ä¸ºï¼š

1. **æ¶ˆæ¯è½ç›˜åå†ç¡®è®¤æˆåŠŸ**ï¼ˆå†™æˆåŠŸæ‰ ackï¼‰ï¼›
2. **æ¶ˆè´¹è€… ack ç¡®è®¤æœºåˆ¶**ï¼ˆæœª ack å¯é‡å‘ï¼‰ï¼›
3. **æ—¥å¿—æ–‡ä»¶ + ç´¢å¼•å¯æ¢å¤**ï¼›
4. **å‰¯æœ¬åŒæ­¥æœºåˆ¶**ï¼ˆä¸»æŒ‚ä»è¡¥ï¼‰ï¼›
5. **å¯é…ç½®åˆ·ç›˜/ç¡®è®¤ç­–ç•¥**ï¼ˆå¯é æ€§å¯è°ƒï¼‰ã€‚

------

å¦‚æœä½ å‘Šè¯‰æˆ‘ä½ è¯´çš„â€œæ¶ˆæ¯æŒä¹…åŒ–â€æ˜¯æŒ‡å“ªç§ç³»ç»Ÿï¼ˆæ¯”å¦‚ **Kafka / RabbitMQ / RocketMQ / Redis Stream**ï¼‰ï¼Œæˆ‘å¯ä»¥å…·ä½“ç”»å‡ºå®ƒçš„æŒä¹…åŒ–æµç¨‹å›¾ï¼Œå¹¶æŒ‡å‡ºåœ¨å®ƒé‡Œé¢**ä¸ºä»€ä¹ˆä¸ä¼šä¸¢**ã€**åœ¨å“ªç§é…ç½®ä¸‹å¯èƒ½ä¸¢**ã€‚

è¦æˆ‘å¸®ä½ å…·ä½“è®²å“ªä¸€ä¸ªå—ï¼Ÿ

# MQå¯¹æ¯”

ä½ é—®çš„è¿™ä¸ªâ€œ**ä¸‡çº§ / åä¸‡çº§ / ç™¾ä¸‡çº§**â€å…¶å®æ˜¯æƒ³äº†è§£ï¼š
 ğŸ‘‰ **RabbitMQã€RocketMQã€Kafka åœ¨ä¸åŒæ¶ˆæ¯é‡çº§ä¸‹ï¼ˆååé‡çº§åˆ«ï¼‰èƒ½ä¸èƒ½æ‰›å¾—ä½ã€å„è‡ªæ€§èƒ½ä¸Šé™å¤§æ¦‚æ˜¯å¤šå°‘ï¼Ÿ**

éå¸¸å¥½çš„é—®é¢˜ï¼æˆ‘ä»¬å°±æŒ‰æ¶ˆæ¯ååé‡çº§åˆ«æ¥å¯¹æ¯”ï¼ˆç»“åˆå®é™…ç”Ÿäº§ç»éªŒä¸å®˜æ–¹ benchmarkï¼‰ã€‚

------

## ğŸ§± ä¸€ã€åŸºæœ¬ç†è§£ï¼šä»€ä¹ˆæ˜¯â€œä¸‡çº§ / åä¸‡çº§ / ç™¾ä¸‡çº§â€

| çº§åˆ«                    | ååé‡å«ä¹‰ï¼ˆæ¶ˆæ¯æ•°/ç§’ï¼‰  | å…¸å‹åœºæ™¯          |
| ----------------------- | ------------------------ | ----------------- |
| **ä¸‡çº§ï¼ˆ1W~5W/sï¼‰**     | ä¸­å°å‹ç³»ç»Ÿã€ä¸šåŠ¡å¼‚æ­¥é˜Ÿåˆ— | ä¸€èˆ¬ä¼ä¸šåå°ä»»åŠ¡  |
| **åä¸‡çº§ï¼ˆ10W~50W/sï¼‰** | ç”µå•†/æ”¯ä»˜/æ—¥å¿—ç³»ç»Ÿ       | ä¸­å¤§å‹åˆ†å¸ƒå¼ä¸šåŠ¡  |
| **ç™¾ä¸‡çº§ï¼ˆ100W+/sï¼‰**   | å¤§æ•°æ®å®æ—¶æµå¤„ç†         | æµ·é‡æ—¥å¿—/åŸ‹ç‚¹ç³»ç»Ÿ |

------

## ğŸš€ äºŒã€RabbitMQ / RocketMQ / Kafka ååèƒ½åŠ›åˆ†çº§å¯¹æ¯”

| MQ ç±»å‹        | è®¾è®¡ç†å¿µ                           | ååé‡çº§åˆ«ï¼ˆæ¶ˆæ¯/ç§’ï¼‰                                  | å…¸å‹åº”ç”¨                     | ç‰¹ç‚¹æ€»ç»“                       |
| -------------- | ---------------------------------- | ------------------------------------------------------ | ---------------------------- | ------------------------------ |
| ğŸ‡ **RabbitMQ** | åŸºäº AMQP åè®®ï¼Œå¯é ä¼˜å…ˆ           | **ä¸‡çº§**ï¼ˆ~1W~5W/sï¼‰ï¼ˆå•èŠ‚ç‚¹æé™çº¦ 2~5 ä¸‡æ¡/sï¼‰        | å°å‹ä»»åŠ¡é˜Ÿåˆ—ã€ä¸šåŠ¡å¼‚æ­¥é€šçŸ¥   | å»¶è¿Ÿä½ã€å¯é æ€§é«˜ã€ååæœ‰é™     |
| â˜„ï¸ **RocketMQ** | é¡ºåºå†™ç£ç›˜ + å¼‚æ­¥åˆ·ç›˜ + é«˜å¹¶å‘è®¾è®¡ | **åä¸‡çº§**ï¼ˆ~10W~30W/sï¼‰ï¼ˆé›†ç¾¤å¯æ‰©å±•è‡³ 100W/sï¼‰        | é‡‘èã€ç”µå•†ã€è®¢å•ç³»ç»Ÿ         | é«˜å¯é ã€é«˜æ‰©å±•æ€§ã€ç¨³å®šæ€§å¼º     |
| ğŸ§© **Kafka**    | æ‰¹é‡é¡ºåºå†™ + é›¶æ‹·è´ + å‰¯æœ¬å¼‚æ­¥åŒæ­¥ | **ç™¾ä¸‡çº§+**ï¼ˆ~100W~1000W/sï¼‰ï¼ˆå¤§è§„æ¨¡é›†ç¾¤å¯è½»æ¾ç ´ç™¾ä¸‡ï¼‰ | æ—¥å¿—æµã€å¤§æ•°æ®é‡‡é›†ã€åŸ‹ç‚¹ç³»ç»Ÿ | æé«˜ååã€ä½å»¶è¿Ÿã€é€‚åˆå¤§æ•°æ®æµ |

------

## âš™ï¸ ä¸‰ã€å®é™…ç”Ÿäº§æ€§èƒ½ç»éªŒï¼ˆä»¥å•æœºæˆ–å°é›†ç¾¤ä¸ºä¾‹ï¼‰

| ç¯å¢ƒ                            | RabbitMQ | RocketMQ | Kafka                  |
| ------------------------------- | -------- | -------- | ---------------------- |
| å•èŠ‚ç‚¹é»˜è®¤é…ç½®                  | ~2W/s    | ~10W/s   | ~50W/s                 |
| ä¼˜åŒ–åï¼ˆSSD + æ‰¹é‡ + å¼‚æ­¥ç¡®è®¤ï¼‰ | ~5W/s    | ~30W/s   | ~100W/s                |
| é›†ç¾¤ï¼ˆ3~5 èŠ‚ç‚¹ï¼‰                | ~10W/s   | ~100W/s  | **~1000W/sï¼ˆç™¾ä¸‡çº§ï¼‰** |

> ğŸ“Œ Kafka çš„é«˜ååæ¥è‡ªï¼š
>
> - **æ‰¹é‡å†™å…¥**ï¼ˆBatch Sendï¼‰
> - **é¡ºåºç£ç›˜ I/O**
> - **é›¶æ‹·è´ï¼ˆsendfileï¼‰ä¼ è¾“**
> - **å¼‚æ­¥å‰¯æœ¬å¤åˆ¶**

------

## âš–ï¸ å››ã€ä¸åŒé‡çº§ä¸‹çš„ MQ é€‰å‹å»ºè®®

| æ¶ˆæ¯é‡çº§                | æ¨è MQ        | åŸå›                              |
| ----------------------- | -------------- | -------------------------------- |
| **ä¸‡çº§ï¼ˆ1W~5W/sï¼‰**     | ğŸ‡ **RabbitMQ** | é…ç½®ç®€å•ã€å¯é æ€§é«˜ã€ç»´æŠ¤è½»       |
| **åä¸‡çº§ï¼ˆ10W~50W/sï¼‰** | â˜„ï¸ **RocketMQ** | é«˜å¯é ã€é«˜æ€§èƒ½ã€æ”¯æŒäº‹åŠ¡         |
| **ç™¾ä¸‡çº§ï¼ˆ100W+/sï¼‰**   | ğŸ§© **Kafka**    | åˆ†å¸ƒå¼é«˜ååã€å¯æ°´å¹³æ‰©å±•ã€ä½å»¶è¿Ÿ |

------

## ğŸ” äº”ã€ç¨³å®šæ€§ä¸æ€§èƒ½å¹³è¡¡ç‚¹

| MQ       | å»¶è¿Ÿ | åå     | å¯é æ€§         | æ‰©å±•æ€§   |
| -------- | ---- | -------- | -------------- | -------- |
| RabbitMQ | ä½   | ä¸­       | é«˜             | ä¸€èˆ¬     |
| RocketMQ | ä¸­   | é«˜       | é«˜             | é«˜       |
| Kafka    | ä¸­   | **è¶…é«˜** | é«˜ï¼ˆacks=allï¼‰ | **æå¼º** |

------

## âœ… å…­ã€æ€»ç»“ä¸€å¥è¯è®°å¿†æ³•ï¼š

| çº§åˆ«   | MQ é€‰æ‹©    | ä¸€å¥è¯è®°å¿†         |
| ------ | ---------- | ------------------ |
| ä¸‡çº§   | ğŸ‡ RabbitMQ | å°å·§ç¨³å®šï¼Œè½»é‡æ˜“ç”¨ |
| åä¸‡çº§ | â˜„ï¸ RocketMQ | å›½äº§åˆ†å¸ƒå¼å¯é çŒ›å°† |
| ç™¾ä¸‡çº§ | ğŸ§© Kafka    | å¤§æ•°æ®æµé‡ååä¹‹ç‹ |

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼ è¿™ä¸‰ä¸ª MQ çš„**æ€§èƒ½çº§åˆ«é›·è¾¾å›¾**æˆ–**é‡çº§åˆ†å¸ƒå›¾**ï¼ˆä¾‹å¦‚æ¯ç§’ååé‡çš„ç›´è§‚å¯¹æ¯”å›¾ï¼‰ï¼Œè®©ä½ ä¸€çœ¼çœ‹æ¸…å“ªç§ MQ é€‚åˆå“ªç§è§„æ¨¡ã€‚
 è¦æˆ‘å¸®ä½ ç”»ä¸€å¼ å›¾å¯è§†åŒ–ä¸€ä¸‹å—ï¼Ÿ

# é˜Ÿåˆ—å¯ä»¥å †ç§¯å¤šå°‘æ¶ˆæ¯

éå¸¸å¥½çš„é—®é¢˜ ğŸ‘ï¼Œè¿™æ˜¯é¢è¯•å’Œå®æˆ˜ä¸­éƒ½**éå¸¸å…³é”®çš„è€ƒç‚¹**ï¼š

> ğŸ’¬ã€Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRabbitMQ / RocketMQ / Kafkaï¼‰æœ€å¤šèƒ½å †ç§¯å¤šå°‘æ¶ˆæ¯ï¼Ÿã€
>  ğŸ’¬ã€Œå †ç§¯å¤šäº†ä¼šä¸ä¼šå´©ï¼Ÿæ€ä¹ˆä¿è¯ä¸ä¸¢ï¼Ÿæ€ä¹ˆä¼˜åŒ–ï¼Ÿã€

æˆ‘ä»¬æ¥åˆ†ä¸‰æ­¥è®²æ¸…æ¥šğŸ‘‡

------

## ğŸ§± ä¸€ã€é¦–å…ˆç†è§£ã€Œæ¶ˆæ¯å †ç§¯ã€çš„æœ¬è´¨

æ¶ˆæ¯å †ç§¯ = **ç”Ÿäº§é€Ÿåº¦ > æ¶ˆè´¹é€Ÿåº¦**
 æ¶ˆæ¯æš‚æ—¶è¢«å­˜å‚¨åœ¨ MQ çš„ç£ç›˜æˆ–å†…å­˜ä¸­ç­‰å¾…è¢«æ¶ˆè´¹ã€‚

ğŸ‘‰ å…³é”®é—®é¢˜ï¼š

- MQ å­˜å‚¨æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ
- å†™å…¥/è¯»å–æ˜¯å¦é¡ºåºï¼Ÿ
- æ˜¯å¦å—å†…å­˜é™åˆ¶ï¼Ÿ
- æ˜¯å¦æ”¯æŒåˆ†ç‰‡æˆ–æ°´å¹³æ‰©å±•ï¼Ÿ

è¿™äº›å†³å®šäº†â€œèƒ½å †å¤šå°‘â€ã€‚

------

## ğŸš€ äºŒã€ä¸‰å¤§ MQ çš„å †ç§¯èƒ½åŠ›å¯¹æ¯”

| MQ             | å­˜å‚¨ä»‹è´¨                  | å•é˜Ÿåˆ—å †ç§¯èƒ½åŠ›                                   | é›†ç¾¤å¯æ‰©å±•æ€§                 | ç‰¹ç‚¹æ€»ç»“                               |
| -------------- | ------------------------- | ------------------------------------------------ | ---------------------------- | -------------------------------------- |
| ğŸ‡ **RabbitMQ** | å†…å­˜ä¸ºä¸» + å¯è½ç›˜         | âš ï¸ ä¸€èˆ¬å»ºè®® â‰¤ **å‡ åä¸‡çº§**ï¼ˆ>100W æ€§èƒ½æ€¥å‰§ä¸‹é™ï¼‰  | æ¨ªå‘æ‰©å±•ä¸€èˆ¬                 | æ¶ˆæ¯è¶Šå¤šå†…å­˜å‹åŠ›è¶Šå¤§ï¼Œä¸é€‚åˆé•¿æ—¶é—´å †ç§¯ |
| â˜„ï¸ **RocketMQ** | å…¨ç£ç›˜é¡ºåºå†™ï¼ˆCommitLogï¼‰ | âœ… å¯è¾¾ **åƒä¸‡çº§ / äº¿çº§**ï¼ˆåªè¦ç£ç›˜å¤Ÿï¼‰           | æ”¯æŒå¤š Topicã€å¤š Broker æ‰©å±• | ä¸“é—¨ä¸ºæµ·é‡å †ç§¯è®¾è®¡                     |
| ğŸ§© **Kafka**    | å…¨ç£ç›˜é¡ºåºå†™ï¼ˆåˆ†åŒºæ—¥å¿—ï¼‰  | âœ… å•åˆ†åŒºå¯è¾¾ **åƒä¸‡çº§**ï¼Œé›†ç¾¤è½»æ¾å † **æ•°åäº¿æ¡** | æ°´å¹³æ‰©å±•æå¼º                 | ä¸“é—¨ä¸ºå¤§è§„æ¨¡æ—¥å¿—å †ç§¯åœºæ™¯è®¾è®¡           |

------

## ğŸ§© ä¸‰ã€è¯¦ç»†è¯´æ˜

### ğŸ‡ RabbitMQ å †ç§¯èƒ½åŠ›ï¼ˆä½~ä¸­ï¼‰

- æ¶ˆæ¯é»˜è®¤ä¼šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå†…å­˜ä¸å¤Ÿæ—¶å†™å…¥ç£ç›˜ï¼›

- å½“å †ç§¯è¿‡å¤šï¼ˆå‡ åä¸‡æ¡ä»¥ä¸Šï¼‰ï¼š

  - å†…å­˜æº¢å‡ºé£é™©ï¼›
  - æ¶ˆæ¯ååä¸‹é™ï¼›
  - æ¶ˆè´¹å»¶è¿Ÿå¢å¤§ï¼›

- å®˜æ–¹æ¨èï¼š

  > **å•é˜Ÿåˆ—å †ç§¯ä¸è¶…è¿‡å‡ åä¸‡æ¡ï¼ˆçº¦ 1~5 ä¸‡è¾ƒå®‰å…¨ï¼‰**

- è§£å†³æ–¹æ¡ˆï¼š

  - å¼€å¯ lazy queueï¼ˆæƒ°æ€§é˜Ÿåˆ—ï¼Œæ¶ˆæ¯ç›´æ¥è½ç›˜ï¼‰ï¼›
  - æˆ–åˆ†ç‰‡ï¼ˆå¤šä¸ªé˜Ÿåˆ—å¹¶è¡Œæ¶ˆè´¹ï¼‰ã€‚

âœ… **é€‚åˆï¼šå®æ—¶æ€§é«˜ã€æ¶ˆæ¯é‡ä¸­ç­‰çš„ç³»ç»Ÿï¼ˆä»»åŠ¡é˜Ÿåˆ—ç±»ï¼‰**
 âš ï¸ ä¸é€‚åˆåšâ€œæ¶ˆæ¯å †ç§¯ä»“åº“â€ã€‚

------

### â˜„ï¸ RocketMQ å †ç§¯èƒ½åŠ›ï¼ˆä¸­~é«˜ï¼‰

- æ¶ˆæ¯éƒ½å†™å…¥ **CommitLog**ï¼ˆé¡ºåºç£ç›˜å†™ï¼‰ï¼›
- æ¶ˆæ¯æ¶ˆè´¹åä¸ä¼šç«‹å³åˆ é™¤ï¼Œè€Œæ˜¯é€»è¾‘ç´¢å¼•ç§»åŠ¨ï¼›
- å¯ä»¥å †ç§¯åƒä¸‡ç”šè‡³ä¸Šäº¿æ¶ˆæ¯ï¼ˆç£ç›˜å¤Ÿå¤§å³å¯ï¼‰ï¼›
- æ¶ˆè´¹è¿›åº¦åœ¨ `ConsumeQueue` è®°å½•ï¼›
- é¡ºåºè¯»å†™ï¼Œä¸æ€•å †ç§¯å¤šã€‚

âœ… **å•æœºå¯å †ç§¯ä¸Šåƒä¸‡æ¡ï¼Œé›†ç¾¤å¯ä¸Šäº¿æ¡ã€‚**
 âš™ï¸ å¯è°ƒå‚æ•°ï¼š

```properties
messageStoreFlushInterval = 500
messageStoreCommitLogSize = 1G
```

------

### ğŸ§© Kafka å †ç§¯èƒ½åŠ›ï¼ˆæé«˜ï¼‰

- Kafka çš„è®¾è®¡æ ¸å¿ƒå°±æ˜¯â€œæµ·é‡å †ç§¯â€ï¼šæ¶ˆæ¯å°±æ˜¯æ—¥å¿—æ–‡ä»¶ï¼›

- å†™å…¥é‡‡ç”¨é¡ºåºå†™ + é¡µç¼“å­˜ + é›¶æ‹·è´ï¼›

- æ¶ˆè´¹è€…åªä¿å­˜ offsetï¼Œä¸åˆ é™¤æ—§æ¶ˆæ¯ï¼›

- æ¶ˆæ¯å¯ä¿ç•™æŒ‰æ—¶é—´æˆ–å¤§å°ç­–ç•¥ï¼Œå¦‚ï¼š

  ```properties
  log.retention.hours=168  # ä¿ç•™7å¤©
  log.retention.bytes=1073741824  # ä¿ç•™1GB
  ```

- æ‰€ä»¥ç†è®ºä¸Šåªå—**ç£ç›˜å¤§å°é™åˆ¶**ã€‚

âœ… **å• Broker å¯å †ç§¯ä¸Šäº¿æ¡ï¼Œé›†ç¾¤è½»æ¾å †ç§¯æ•°åäº¿ã€‚**
 ğŸ’¨ ä¸”è¯»å†™æ€§èƒ½ä¾æ—§å¾ˆé«˜ã€‚

------

## ğŸ“Š å››ã€å †ç§¯è¿‡å¤šçš„åæœ

| é—®é¢˜          | åŸå›                    | å½±å“               |
| ------------- | ---------------------- | ------------------ |
| æ¶ˆè´¹å»¶è¿Ÿé«˜    | æ¶ˆè´¹é€Ÿåº¦ < ç”Ÿäº§é€Ÿåº¦    | æ¶ˆæ¯ç§¯å‹ã€å¤„ç†è¶…æ—¶ |
| å†…å­˜/ç£ç›˜å‹åŠ› | æœªæ¶ˆè´¹æ¶ˆæ¯å¤ªå¤š         | å¯èƒ½è§¦å‘é™æµæˆ–å´©æºƒ |
| é‡å¯æ…¢        | å¯åŠ¨éœ€åŠ è½½å¤§é‡æ¶ˆæ¯ç´¢å¼• | å¯åŠ¨æ—¶é—´æ˜¾è‘—å˜é•¿   |
| åˆ é™¤æ…¢        | æ¸…ç†è€æ•°æ®éœ€è¦åå°çº¿ç¨‹ | ç£ç›˜æŠ–åŠ¨ã€æ€§èƒ½ä¸‹é™ |

------

## ğŸ§  äº”ã€å¦‚ä½•åº”å¯¹å †ç§¯é—®é¢˜

| æ–¹æ³•                                  | åŸç†                         |
| ------------------------------------- | ---------------------------- |
| âœ… å¢åŠ æ¶ˆè´¹è€…æ•°é‡                      | æå‡æ¶ˆè´¹é€Ÿåº¦ï¼ˆå¹¶è¡Œæ¶ˆè´¹ï¼‰     |
| âœ… æ‰©åˆ†åŒº/æ‰©Topic                      | åˆ†æ•£å †ç§¯å‹åŠ›                 |
| âœ… ä½¿ç”¨æƒ°æ€§é˜Ÿåˆ—ï¼ˆRabbitMQ Lazy Queueï¼‰ | æ¶ˆæ¯ç›´æ¥å†™ç£ç›˜ï¼Œå‡å°‘å†…å­˜å ç”¨ |
| âœ… RocketMQ/Kafka åˆ†å¸ƒå¼æ‰©å®¹           | æ¨ªå‘æ‰©å±•èŠ‚ç‚¹                 |
| âœ… æ¶ˆè´¹ç«¯é™æµ + å‘Šè­¦æœºåˆ¶               | åŠæ—¶å‘ç°å †ç§¯                 |
| âœ… è°ƒæ•´ä¿ç•™ç­–ç•¥                        | æŒ‰æ—¶é—´æˆ–å¤§å°å®šæœŸæ¸…ç†         |

------

## ğŸ§® å…­ã€æ€»ç»“ä¸€å¥è¯è®°å¿†ï¼š

| MQ           | å•é˜Ÿåˆ—å®‰å…¨å †ç§¯é‡çº§ | é€‚åˆåœºæ™¯            |
| ------------ | ------------------ | ------------------- |
| **RabbitMQ** | ä¸‡çº§ï¼ˆâ‰¤10Wï¼‰       | å®æ—¶ä»»åŠ¡é˜Ÿåˆ—        |
| **RocketMQ** | åƒä¸‡çº§             | ä¸šåŠ¡æ¶ˆæ¯ã€äº¤æ˜“ç³»ç»Ÿ  |
| **Kafka**    | äº¿çº§+              | æ—¥å¿—æµ / å¤§æ•°æ®ç®¡é“ |

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼  â€œä¸‰å¤§ MQ æ¶ˆæ¯å †ç§¯èƒ½åŠ›å¯¹æ¯”æŸ±çŠ¶å›¾â€ï¼Œè®©ä½ ç›´è§‚çœ‹å‡º RabbitMQã€RocketMQã€Kafka çš„å·®è·ã€‚
 è¦æˆ‘ç”»ä¸€å¼ å›¾å¯è§†åŒ–çœ‹çœ‹å—ï¼Ÿ

# è½ç›˜

éå¸¸æ£’çš„é—®é¢˜ ğŸ‘
 ä½ é—®çš„â€œ**è½ç›˜æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ**â€å…¶å®æ˜¯ç†è§£æ¶ˆæ¯ä¸­é—´ä»¶ã€æ•°æ®åº“ã€ç”šè‡³æ“ä½œç³»ç»Ÿå¯é æ€§æœºåˆ¶çš„**å…³é”®æ¦‚å¿µ**ã€‚
 æˆ‘æ¥ç”¨é€šä¿— + æŠ€æœ¯ç»†èŠ‚çš„æ–¹å¼å¸®ä½ å½»åº•ææ‡‚ğŸ‘‡

------

## ğŸ§  ä¸€ã€å…ˆè¯´å®šä¹‰ï¼šä»€ä¹ˆå«â€œè½ç›˜â€

> **è½ç›˜ï¼ˆFlush to Disk / æŒä¹…åŒ–å†™å…¥ï¼‰**ï¼Œ
>  å°±æ˜¯æŠŠæ•°æ®ä»**å†…å­˜ï¼ˆMemory / Page Cacheï¼‰**çœŸæ­£å†™å…¥**ç£ç›˜ï¼ˆDisk / SSDï¼‰**çš„è¿‡ç¨‹ã€‚

------

### ğŸ§© ä¸¾ä¸ªæœ€ç›´è§‚çš„ä¾‹å­ï¼š

æ¯”å¦‚ä½ åœ¨å†™æ–‡ä»¶ï¼š

```java
FileOutputStream out = new FileOutputStream("data.log");
out.write("hello".getBytes());
out.close();
```

ğŸ’¡ ä½ ä»¥ä¸ºæ•°æ®å·²ç»å†™è¿›ç£ç›˜äº†ï¼Ÿ
 å…¶å®è¿˜æ²¡ã€‚

------

### âš™ï¸ å®é™…è¿‡ç¨‹å¦‚ä¸‹ï¼š

| é˜¶æ®µ         | å­˜å‚¨ä½ç½®             | æè¿°                                        |
| ------------ | -------------------- | ------------------------------------------- |
| â‘  åº”ç”¨å±‚å†™å…¥ | JVM å †å†…å­˜           | è°ƒç”¨ `write()` åªæ˜¯æŠŠæ•°æ®å†™å…¥**å†…æ ¸ç¼“å†²åŒº** |
| â‘¡ å†…æ ¸ç¼“å­˜   | Page Cacheï¼ˆOSå†…å­˜ï¼‰ | æ“ä½œç³»ç»Ÿæš‚å­˜æ•°æ®ï¼Œæé«˜ I/O æ€§èƒ½             |
| â‘¢ ç£ç›˜å†™å…¥   | Disk / SSD           | è°ƒç”¨ `fsync()` / `flush()` åæ‰**çœŸæ­£è½ç›˜** |

ğŸ‘‰ æ‰€ä»¥ï¼š

- å¦‚æœç³»ç»Ÿåœ¨ `fsync` å‰å®•æœºï¼Œæ•°æ®ä¼šä¸¢ï¼›
- â€œè½ç›˜â€ å°±æ˜¯æ‰§è¡Œè¿™ä¸ª **`fsync()` â†’ æŠŠæ•°æ®ä»å†…å­˜åˆ·å…¥ç£ç›˜** çš„åŠ¨ä½œã€‚

------

## ğŸ’¾ äºŒã€ä¸ºä»€ä¹ˆè¦â€œè½ç›˜â€

**ç›®çš„ï¼šä¿è¯æ•°æ®å¯é æ€§ã€‚**

å†…å­˜ä¸­çš„æ•°æ®æ˜¯**æ˜“å¤±çš„ï¼ˆvolatileï¼‰**ï¼š

- ç¨‹åºå´©äº†ã€æ–­ç”µäº†ã€OSé‡å¯äº† â€”â€” éƒ½ä¼šä¸¢ã€‚
- ç£ç›˜ä¸Šçš„æ•°æ®æ‰æ˜¯æŒä¹…çš„ã€‚

æ‰€ä»¥æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€æ—¥å¿—ç³»ç»Ÿéƒ½ä¼šå®šæœŸæ‰§è¡Œâ€œè½ç›˜ï¼ˆflushï¼‰â€æ“ä½œï¼Œç¡®ä¿å³ä½¿å®•æœºä¹Ÿèƒ½æ¢å¤ã€‚

------

## âš™ï¸ ä¸‰ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„â€œè½ç›˜â€

| MQ           | è½ç›˜ä½ç½®             | è½ç›˜æœºåˆ¶                              | è¯´æ˜                                 |
| ------------ | -------------------- | ------------------------------------- | ------------------------------------ |
| **RabbitMQ** | ç£ç›˜é˜Ÿåˆ—æ–‡ä»¶ï¼ˆ.rdqï¼‰ | å¼‚æ­¥å†™ç£ç›˜ï¼Œå¯é…ç½®ä¸º confirm å flush | æ€§èƒ½è¾ƒä½ä½†ä¿è¯æ¶ˆæ¯å¯é                |
| **RocketMQ** | CommitLog æ–‡ä»¶       | å¼‚æ­¥ / åŒæ­¥è½ç›˜ï¼ˆå¯é€‰ï¼‰               | åŒæ­¥è½ç›˜æœ€å®‰å…¨ï¼ˆç¡®è®¤å†™å®Œç£ç›˜æ‰è¿”å›ï¼‰ |
| **Kafka**    | åˆ†åŒºæ—¥å¿—æ–‡ä»¶         | å¼‚æ­¥æ‰¹é‡åˆ·ç›˜ï¼Œå®šæœŸ fsync              | é«˜æ€§èƒ½ï¼Œé€‚åˆå¤§æ•°æ®æµé‡               |

------

### ğŸ§© ä¸¾ä¸ª RocketMQ çš„ä¾‹å­ï¼š

å‡è®¾ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ï¼š

```
Producer -> Broker -> CommitLog -> åˆ·ç›˜ -> è¿”å›ACK
```

- **å¼‚æ­¥åˆ·ç›˜ï¼ˆé»˜è®¤ï¼‰**ï¼šå†™å…¥ OS ç¼“å­˜å°±è¿”å› ACKï¼ˆé«˜æ€§èƒ½ï¼Œå¯èƒ½ä¸¢ï¼‰
- **åŒæ­¥åˆ·ç›˜**ï¼šå†™å…¥ç£ç›˜æ–‡ä»¶åå†è¿”å› ACKï¼ˆé«˜å¯é ï¼Œä¸ä¸¢ï¼‰

é…ç½®ï¼š

```properties
flushDiskType = SYNC_FLUSH  # åŒæ­¥åˆ·ç›˜
```

------

## âš¡ å››ã€è½ç›˜çš„æ€§èƒ½å½±å“

è½ç›˜æ˜¯ä¸ªâ€œ**æ…¢æ“ä½œ**â€ï¼š

- å†™å†…å­˜ï¼šå‡ çº³ç§’ï¼›
- å†™ç£ç›˜ï¼šå‡ æ¯«ç§’ï¼›
- fsyncï¼šç³»ç»Ÿè°ƒç”¨ï¼Œéœ€è¦ç­‰å¾…ç£ç›˜æ§åˆ¶å™¨å“åº”ã€‚

æ‰€ä»¥ï¼Œå¾ˆå¤šç³»ç»Ÿé‡‡ç”¨ï¼š

- **å¼‚æ­¥è½ç›˜**ï¼ˆæ€§èƒ½é«˜ï¼Œä½†å¯èƒ½ä¸¢ï¼‰ï¼›
- **æ‰¹é‡è½ç›˜**ï¼ˆç§¯ç´¯ä¸€æ‰¹æ¶ˆæ¯å†ä¸€æ¬¡ fsyncï¼‰ï¼›
- **å¼‚æ­¥åˆ·ç›˜çº¿ç¨‹**ï¼ˆåå°å‘¨æœŸæ€§ fsyncï¼‰ã€‚

Kafkaã€RocketMQ éƒ½ç”¨äº†è¿™äº›ä¼˜åŒ–æ‰‹æ®µï¼Œä½¿å¾—æ€§èƒ½å’Œå¯é æ€§ä¹‹é—´å¯ä»¥æƒè¡¡ã€‚

------

## ğŸ“Š äº”ã€ä¸¾ä¾‹è¯´æ˜å·®å¼‚ï¼ˆå¼‚æ­¥ vs åŒæ­¥ï¼‰

| ç±»å‹     | è½ç›˜ç­–ç•¥             | å¯é æ€§          | ååé‡ | åœºæ™¯                 |
| -------- | -------------------- | --------------- | ------ | -------------------- |
| å¼‚æ­¥è½ç›˜ | å†™å…¥å†…æ ¸ç¼“å­˜å³è¿”å›   | å®•æœºå¯èƒ½ä¸¢      | é«˜     | æ—¥å¿—æµã€å¤§æ•°æ®       |
| åŒæ­¥è½ç›˜ | å†™å…¥ç£ç›˜æ–‡ä»¶åæ‰è¿”å› | æœ€å®‰å…¨          | ä½     | é‡‘èã€è®¢å•ã€äº¤æ˜“ç³»ç»Ÿ |
| æ‰¹é‡è½ç›˜ | æ¯éš”å‡ æ¯«ç§’ç»Ÿä¸€ fsync | å¯é  + æ€§èƒ½æŠ˜ä¸­ | ä¸­     | RocketMQ é»˜è®¤æ¨¡å¼    |

------

## ğŸ§© å…­ã€æ€»ç»“ä¸€å¥è¯è®°å¿†ï¼š

> ğŸ’¬ **â€œè½ç›˜â€å°±æ˜¯æŠŠæ•°æ®ä»å†…å­˜çœŸæ­£å†™å…¥ç£ç›˜ï¼Œç¡®ä¿æ‰ç”µå®•æœºä¸ä¸¢å¤±ã€‚**
>
> MQã€æ•°æ®åº“ã€æ—¥å¿—ç³»ç»Ÿéƒ½è¦åšè½ç›˜ï¼ŒåŒºåˆ«åªæ˜¯ **ä½•æ—¶è½**ã€**æ€ä¹ˆè½**ã€**æ˜¯å¦åŒæ­¥ç­‰å¾…**ã€‚

------

## âœ… ä¸ƒã€å»¶ä¼¸ï¼šæ•°æ®åº“ä¸­çš„è½ç›˜ï¼ˆåŒç†ï¼‰

MySQL / InnoDB ä¹Ÿä¸€æ ·ï¼š

- å†™å…¥ç¼“å†²åŒºï¼ˆBuffer Poolï¼‰ï¼›
- å†™å…¥ redo logï¼›
- æ‰§è¡Œ `fsync` æ‰ç®—çœŸæ­£æŒä¹…åŒ–ã€‚

äº‹åŠ¡æäº¤æ—¶çš„ `innodb_flush_log_at_trx_commit` å‚æ•°æ§åˆ¶è½ç›˜ç­–ç•¥ï¼š

| å€¼   | å«ä¹‰             | å®‰å…¨æ€§ |
| ---- | ---------------- | ------ |
| 0    | å¼‚æ­¥å†™           | å¯èƒ½ä¸¢ |
| 1    | åŒæ­¥å†™ï¼ˆæœ€å®‰å…¨ï¼‰ | âœ… ä¸ä¸¢ |
| 2    | æ¯ç§’ fsync ä¸€æ¬¡  | æŠ˜ä¸­   |

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼ å›¾ï¼Œå±•ç¤ºâ€œåº”ç”¨å†™å…¥ â†’ ç¼“å­˜ â†’ ç£ç›˜è½ç›˜â€çš„æ•´ä¸ªè¿‡ç¨‹ï¼ˆåŒ…æ‹¬ fsync é˜¶æ®µï¼‰ï¼Œè®©ä½ ç›´è§‚çœ‹å‡ºæ•°æ®æ˜¯æ€ä¹ˆä¸€æ­¥æ­¥è½ç›˜çš„ã€‚
 è¦æˆ‘å¸®ä½ ç”»å‡ºæ¥å—ï¼Ÿ